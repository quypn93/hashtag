@using HashTag.Helpers
@using Microsoft.AspNetCore.Localization
@model HashtagDetailsViewModel
@{
    var requestCulture = Context.Features.Get<IRequestCultureFeature>();
    var currentCulture = requestCulture?.RequestCulture.UICulture.Name ?? "vi";
    var isEnglish = currentCulture.StartsWith("en");

    var categoryName = Model.Hashtag.Category != null
        ? (!isEnglish && !string.IsNullOrEmpty(Model.Hashtag.Category.DisplayNameVi) ? Model.Hashtag.Category.DisplayNameVi : Model.Hashtag.Category.Name)
        : "TikTok";

    var viewCount = Model.Hashtag.LatestViewCount.HasValue && Model.Hashtag.LatestViewCount > 0
        ? (Model.Hashtag.LatestViewCount.Value >= 1_000_000_000
            ? $"{Model.Hashtag.LatestViewCount.Value / 1_000_000_000.0:F1}B"
            : Model.Hashtag.LatestViewCount.Value >= 1_000_000
                ? $"{Model.Hashtag.LatestViewCount.Value / 1_000_000.0:F1}M"
                : Localizer["Details_Many"].Value)
        : Localizer["Details_Many"].Value;

    ViewData["Title"] = string.Format(Localizer["Details_PageTitle"].Value, Model.Hashtag.TagDisplay);
    ViewData["Description"] = string.Format(Localizer["Details_PageDescription"].Value, Model.Hashtag.TagDisplay, viewCount, Model.Hashtag.TotalAppearances, categoryName);
    ViewData["Keywords"] = $"{Model.Hashtag.Tag.Trim()}, hashtag tiktok, {categoryName}, trending hashtag, viral hashtag, hashtag hot";
    Layout = "_LayoutPublic";
}

<style>
    /* Modern Card Styling */
    .metric-card {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
        text-align: center;
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    .gradient-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 3rem 0 2rem;
        margin: -2rem 0 2rem 0;
        border-radius: 0 0 2rem 2rem;
    }

    .info-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .related-item {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .related-item:hover {
        background-color: #f8f9fa;
        border-left-color: #667eea;
        transform: translateX(5px);
    }

    .history-table thead {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .history-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .history-table tbody tr:hover {
        background-color: #f8f9fa;
    }
</style>

<!-- Gradient Header -->
<div class="gradient-header">
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb breadcrumb-transparent mb-0">
                @* <li class="breadcrumb-item"><a href="@Url.Action("Index", "Hashtag")" class="text-white">Trang chủ</a></li> *@
                <li class="breadcrumb-item active text-white-50">@Model.Hashtag.TagDisplay</li>
            </ol>
        </nav>
        <h1 class="display-3 text-white mb-2 fw-bold">@Model.Hashtag.TagDisplay</h1>
        <div class="d-flex flex-wrap gap-2 mt-3 align-items-center">
            @if (Model.Hashtag.Category != null)
            {
                <span class="info-badge bg-white text-dark">
                    <i class="bi bi-folder"></i> @(!isEnglish && !string.IsNullOrEmpty(Model.Hashtag.Category.DisplayNameVi) ? Model.Hashtag.Category.DisplayNameVi : Model.Hashtag.Category.Name)
                </span>
            }
            @if (!string.IsNullOrEmpty(Model.Hashtag.DifficultyLevel))
            {
                var badgeClass = Model.Hashtag.DifficultyLevel switch
                {
                    "Easy" => "bg-success",
                    "Medium" => "bg-warning",
                    "Hard" => "bg-danger",
                    _ => "bg-secondary"
                };
                var difficultyText = Model.Hashtag.DifficultyLevel switch
                {
                    "Easy" => Localizer["Difficulty_Low"].Value,
                    "Medium" => Localizer["Difficulty_Medium"].Value,
                    "Hard" => Localizer["Difficulty_High"].Value,
                    "Very Hard" => Localizer["Difficulty_VeryHigh"].Value,
                    _ => Model.Hashtag.DifficultyLevel
                };
                <span class="text-white">@Localizer["Details_CompetitionLevel"] </span>
                <span class="info-badge @badgeClass text-white">
                    <i class="bi bi-speedometer"></i> @difficultyText
                </span>
            }
        </div>
    </div>
</div>

<div class="container">
    @* Key Metrics Cards *@
    <div class="row g-4 mb-4">
        @* Total Appearances *@
        <div class="col-md-3 col-sm-6">
            <div class="metric-card card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3 justify-content-center">
                        <div class="metric-icon metric-icon-primary">
                            <i class="bi bi-bar-chart-fill"></i>
                        </div>
                    </div>
                    <div class="metric-value">@Model.Hashtag.TotalAppearances</div>
                    <div class="metric-label">@Localizer["Details_TotalAppearances"]</div>
                </div>
            </div>
        </div>

        @* View Count *@
        @if (Model.Hashtag.LatestViewCount.HasValue && Model.Hashtag.LatestViewCount > 0)
        {
            var viewCountFormatted = Model.Hashtag.LatestViewCount.Value >= 1_000_000_000
                ? $"{Model.Hashtag.LatestViewCount.Value / 1_000_000_000.0:F1}B"
                : Model.Hashtag.LatestViewCount.Value >= 1_000_000
                    ? $"{Model.Hashtag.LatestViewCount.Value / 1_000_000.0:F1}M"
                    : Model.Hashtag.LatestViewCount.Value >= 1000
                        ? $"{Model.Hashtag.LatestViewCount.Value / 1000.0:F1}K"
                        : Model.Hashtag.LatestViewCount.Value.ToString("N0");

            <div class="col-md-3 col-sm-6">
                <div class="metric-card card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3 justify-content-center">
                            <div class="metric-icon metric-icon-secondary">
                                <i class="bi bi-eye-fill"></i>
                            </div>
                        </div>
                        <div class="metric-value text-danger">@viewCountFormatted</div>
                        <div class="metric-label">@Localizer["Details_LatestViews"]</div>
                    </div>
                </div>
            </div>
        }

        @* Post Count *@
        @if (Model.Hashtag.LatestPostCount.HasValue && Model.Hashtag.LatestPostCount > 0)
        {
            var postCountFormatted = Model.Hashtag.LatestPostCount.Value >= 1_000_000
                ? $"{Model.Hashtag.LatestPostCount.Value / 1_000_000.0:F1}M"
                : Model.Hashtag.LatestPostCount.Value >= 1000
                    ? $"{Model.Hashtag.LatestPostCount.Value / 1000.0:F1}K"
                    : Model.Hashtag.LatestPostCount.Value.ToString("N0");

            <div class="col-md-3 col-sm-6">
                <div class="metric-card card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3 justify-content-center">
                            <div class="metric-icon metric-icon-success">
                                <i class="bi bi-file-post-fill"></i>
                            </div>
                        </div>
                        <div class="metric-value text-success">@postCountFormatted</div>
                        <div class="metric-label">@Localizer["Details_LatestPosts"]</div>
                    </div>
                </div>
            </div>
        }

        @* Total Views from Metrics *@
        @if (Model.Metrics != null && Model.Metrics.ViewCount.HasValue && Model.Metrics.ViewCount > 0)
        {
            var totalViewsFormatted = Model.Metrics.ViewCount.Value >= 1_000_000_000
                ? $"{Model.Metrics.ViewCount.Value / 1_000_000_000.0:F2}B"
                : Model.Metrics.ViewCount.Value >= 1_000_000
                    ? $"{Model.Metrics.ViewCount.Value / 1_000_000.0:F1}M"
                    : Model.Metrics.ViewCount.Value >= 1000
                        ? $"{Model.Metrics.ViewCount.Value / 1000.0:F1}K"
                        : Model.Metrics.ViewCount.Value.ToString("N0");

            <div class="col-md-3 col-sm-6">
                <div class="metric-card card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3 justify-content-center">
                            <div class="metric-icon metric-icon-warning">
                                <i class="bi bi-eye"></i>
                            </div>
                        </div>
                        <div class="metric-value text-warning">@totalViewsFormatted</div>
                        <div class="metric-label">@Localizer["Details_TotalViews"]</div>
                    </div>
                </div>
            </div>
        }
    </div>

    @* Additional Info Cards *@
    <div class="row g-4 mb-4">
        @* Info Card *@
        <div class="col-lg-8">
            <div class="card metric-card">
                <div class="card-header card-header-gradient-secondary">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-info-circle-fill"></i> @Localizer["Details_HashtagInfo"]</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <i class="bi bi-calendar-check text-primary fs-3 me-3"></i>
                                <div>
                                    <small class="text-muted d-block">@Localizer["Details_FirstAppearance"]</small>
                                    <strong>@Model.Hashtag.FirstSeen.ToVietnameseString()</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <i class="bi bi-clock-history text-success fs-3 me-3"></i>
                                <div>
                                    <small class="text-muted d-block">@Localizer["Details_LastAppearance"]</small>
                                    <strong>@Model.Hashtag.LastSeen.ToVietnameseString()</strong>
                                </div>
                            </div>
                        </div>

                        @if (Model.Metrics != null && Model.Metrics.EngagementRate > 0)
                        {
                            var avgViewsFormatted = Model.Metrics.EngagementRate >= 1_000_000
                                ? $"{(Model.Metrics.EngagementRate / 1_000_000m):F1}M"
                                : Model.Metrics.EngagementRate >= 1000
                                    ? $"{(Model.Metrics.EngagementRate / 1000m):F1}K"
                                    : $"{Model.Metrics.EngagementRate:N0}";

                            <div class="col-md-6">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class="bi bi-graph-up text-info fs-3 me-3"></i>
                                    <div>
                                        <small class="text-muted d-block">@Localizer["Details_AvgViewsPerPost"]</small>
                                        <strong class="text-info">@avgViewsFormatted</strong>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (Model.Metrics != null && Model.Metrics.PredictedViewMin.HasValue && Model.Metrics.PredictedViewMax.HasValue)
                        {
                            var minFormatted = Model.Metrics.PredictedViewMin.Value >= 1_000_000
                                ? $"{Model.Metrics.PredictedViewMin.Value / 1_000_000.0:F1}M"
                                : Model.Metrics.PredictedViewMin.Value >= 1000
                                    ? $"{Model.Metrics.PredictedViewMin.Value / 1000.0:F1}K"
                                    : Model.Metrics.PredictedViewMin.Value.ToString("N0");

                            var maxFormatted = Model.Metrics.PredictedViewMax.Value >= 1_000_000
                                ? $"{Model.Metrics.PredictedViewMax.Value / 1_000_000.0:F1}M"
                                : Model.Metrics.PredictedViewMax.Value >= 1000
                                    ? $"{Model.Metrics.PredictedViewMax.Value / 1000.0:F1}K"
                                    : Model.Metrics.PredictedViewMax.Value.ToString("N0");

                            <div class="col-md-6">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class="bi bi-graph-up-arrow text-warning fs-3 me-3"></i>
                                    <div>
                                        <small class="text-muted d-block">@Localizer["Details_PredictedViews"]</small>
                                        <strong class="text-warning">@minFormatted - @maxFormatted</strong>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @if (Model.Metrics != null && Model.Metrics.PredictedViewMin.HasValue)
                    {
                        <div class="alert alert-info alert-border-info mt-3 mb-0">
                            <i class="bi bi-info-circle"></i> @Localizer["Details_PredictedViewsHint"]
                        </div>
                    }
                </div>
            </div>
        </div>

        @* Related Hashtags & Creators *@
        <div class="col-lg-4">
            @* Related Hashtags *@
            <div class="card metric-card mb-4">
                <div class="card-header card-header-gradient-primary">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-link-45deg"></i> @Localizer["Details_RelatedHashtags"]</h5>
                </div>
                <div class="card-body">
                    @if (Model.RelatedHashtags.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var relatedHashtag in Model.RelatedHashtags.Take(5))
                            {
                                var viewCountFormatted = relatedHashtag.LatestViewCount.HasValue && relatedHashtag.LatestViewCount > 0
                                    ? (relatedHashtag.LatestViewCount.Value >= 1_000_000_000
                                        ? $"{relatedHashtag.LatestViewCount.Value / 1_000_000_000.0:F1}B"
                                        : relatedHashtag.LatestViewCount.Value >= 1_000_000
                                            ? $"{relatedHashtag.LatestViewCount.Value / 1_000_000.0:F1}M"
                                            : relatedHashtag.LatestViewCount.Value >= 1000
                                                ? $"{relatedHashtag.LatestViewCount.Value / 1000.0:F1}K"
                                                : relatedHashtag.LatestViewCount.Value.ToString("N0"))
                                    : null;

                                <a href="@Url.Action("Details", new { slug = relatedHashtag.Tag.Trim() })" class="related-item list-group-item list-group-item-action border-0 d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="bi bi-hash text-primary"></i>
                                        <strong>@relatedHashtag.Tag.Trim()</strong>
                                    </span>
                                    @if (viewCountFormatted != null)
                                    {
                                        <span class="badge bg-primary rounded-pill" title="@relatedHashtag.LatestViewCount!.Value.ToString("N0") @Localizer["Details_Views"]">
                                            @viewCountFormatted
                                        </span>
                                    }
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0 text-center py-3">
                            <i class="bi bi-info-circle"></i> @Localizer["Details_NoRelatedHashtags"]
                        </p>
                    }
                </div>
            </div>

            @* Top Creators *@
            @{
                var latestHistoryWithCreators = Model.History
                    .Where(h => !string.IsNullOrEmpty(h.FeaturedCreatorsJson))
                    .OrderByDescending(h => h.CollectedDate)
                    .FirstOrDefault();
            }

            @if (latestHistoryWithCreators != null)
            {
                <div class="card metric-card">
                    <div class="card-header card-header-gradient-success">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-people-fill"></i> @Localizer["Details_TopCreators"]</h5>
                    </div>
                    <div class="card-body">
                        <div id="creatorsContainer" data-creators='@latestHistoryWithCreators.FeaturedCreatorsJson'></div>
                    </div>
                </div>
            }
        </div>
    </div>

    @* Usage Tips & Best Practices *@
    <div class="row mb-4">
        <div class="col-12">
            <div class="card metric-card">
                <div class="card-header card-header-gradient-primary">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-lightbulb-fill"></i> @string.Format(Localizer["Details_HowToUse"].Value, Model.Hashtag.TagDisplay)</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-check2-circle"></i> @Localizer["Details_OptimizeContent"]</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-arrow-right-circle-fill text-success me-2"></i>@Localizer["Details_Tip1"]</li>
                                <li class="mb-2"><i class="bi bi-arrow-right-circle-fill text-success me-2"></i>@Localizer["Details_Tip2"]</li>
                                <li class="mb-2"><i class="bi bi-arrow-right-circle-fill text-success me-2"></i>@Localizer["Details_Tip3"]</li>
                                <li class="mb-2"><i class="bi bi-arrow-right-circle-fill text-success me-2"></i>@Localizer["Details_Tip4"]</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-x-circle"></i> @Localizer["Details_UsageNotes"]</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>@Localizer["Details_Warning1"]</li>
                                <li class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>@Localizer["Details_Warning2"]</li>
                                <li class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>@Localizer["Details_Warning3"]</li>
                                <li class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>@Localizer["Details_Warning4"]</li>
                            </ul>
                        </div>
                    </div>

                    @if (Model.Hashtag.Category != null)
                    {
                        var tipCategoryName = !isEnglish && !string.IsNullOrEmpty(Model.Hashtag.Category.DisplayNameVi)
                            ? Model.Hashtag.Category.DisplayNameVi
                            : Model.Hashtag.Category.Name;
                        <div class="alert alert-info mt-3 mb-0 border-start border-4" style="border-left-color: #0dcaf0 !important;">
                            <i class="bi bi-info-circle-fill"></i> @Html.Raw(string.Format(Localizer["Details_CategoryTip"].Value, $"<strong>{tipCategoryName}</strong>"))
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @* Statistics Insights *@
    <div class="row mb-4">
        <div class="col-12">
            <div class="card metric-card">
                <div class="card-header card-header-gradient-success">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-graph-up-arrow"></i> @Localizer["Details_AnalyticsTitle"]</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        @* Trend Analysis *@
                        <div class="col-md-4">
                            <div class="p-4 bg-light rounded text-center h-100">
                                <i class="bi bi-fire text-danger fs-1 mb-3 d-block"></i>
                                <h6 class="fw-bold mb-2">@Localizer["Details_HotLevel"]</h6>
                                @{
                                    var trendLevel = Model.Hashtag.TotalAppearances >= 20 ? Localizer["Details_VeryHot"].Value
                                        : Model.Hashtag.TotalAppearances >= 10 ? Localizer["Details_Hot"].Value
                                        : Model.Hashtag.TotalAppearances >= 5 ? Localizer["Details_QuiteHot"].Value
                                        : Localizer["Details_Emerging"].Value;
                                    var trendClass = Model.Hashtag.TotalAppearances >= 20 ? "text-danger"
                                        : Model.Hashtag.TotalAppearances >= 10 ? "text-warning"
                                        : "text-info";
                                }
                                <p class="fs-4 fw-bold @trendClass mb-2">@trendLevel</p>
                                <small class="text-muted">@string.Format(Localizer["Details_AppearancesInTrending"].Value, Model.Hashtag.TotalAppearances)</small>
                            </div>
                        </div>

                        @* Competition Level *@
                        <div class="col-md-4">
                            <div class="p-4 bg-light rounded text-center h-100">
                                <i class="bi bi-speedometer2 text-primary fs-1 mb-3 d-block"></i>
                                <h6 class="fw-bold mb-2">@Localizer["Details_Competition"]</h6>
                                @{
                                    var competitionText = Model.Hashtag.DifficultyLevel switch
                                    {
                                        "Easy" => Localizer["Details_CompetitionLow"].Value,
                                        "Medium" => Localizer["Details_CompetitionMedium"].Value,
                                        "Hard" => Localizer["Details_CompetitionHigh"].Value,
                                        "Very Hard" => Localizer["Details_CompetitionVeryHigh"].Value,
                                        _ => Localizer["Details_CompetitionUnknown"].Value
                                    };
                                    var competitionClass = Model.Hashtag.DifficultyLevel switch
                                    {
                                        "Easy" => "text-success",
                                        "Medium" => "text-warning",
                                        "Hard" or "Very Hard" => "text-danger",
                                        _ => "text-secondary"
                                    };
                                }
                                <p class="fs-5 fw-bold @competitionClass mb-2">@competitionText</p>
                                @if (Model.Hashtag.LatestPostCount.HasValue && Model.Hashtag.LatestPostCount > 0)
                                {
                                    <small class="text-muted">@string.Format(Localizer["Details_PostsUsing"].Value, Model.Hashtag.LatestPostCount.Value.ToString("N0"))</small>
                                }
                            </div>
                        </div>

                        @* Performance Score *@
                        <div class="col-md-4">
                            <div class="p-4 bg-light rounded text-center h-100">
                                <i class="bi bi-star-fill text-warning fs-1 mb-3 d-block"></i>
                                <h6 class="fw-bold mb-2">@Localizer["Details_Performance"]</h6>
                                @{
                                    // Calculate performance based on views/post ratio
                                    var performanceScore = Model.Metrics != null && Model.Metrics.EngagementRate > 0
                                        ? (Model.Metrics.EngagementRate >= 100000 ? Localizer["Details_PerformanceExcellent"].Value
                                            : Model.Metrics.EngagementRate >= 50000 ? Localizer["Details_PerformanceGood"].Value
                                            : Model.Metrics.EngagementRate >= 10000 ? Localizer["Details_PerformanceFair"].Value
                                            : Localizer["Details_PerformanceAverage"].Value)
                                        : Localizer["Details_CollectingData"].Value;
                                    var performanceClass = Model.Metrics != null && Model.Metrics.EngagementRate >= 50000
                                        ? "text-success"
                                        : "text-info";
                                }
                                <p class="fs-5 fw-bold @performanceClass mb-2">@performanceScore</p>
                                @if (Model.Metrics != null && Model.Metrics.EngagementRate > 0)
                                {
                                    var avgViews = Model.Metrics.EngagementRate >= 1_000_000
                                        ? $"{(Model.Metrics.EngagementRate / 1_000_000m):F1}M"
                                        : Model.Metrics.EngagementRate >= 1000
                                            ? $"{(Model.Metrics.EngagementRate / 1000m):F1}K"
                                            : $"{Model.Metrics.EngagementRate:N0}";
                                    <small class="text-muted">@string.Format(Localizer["Details_AvgViews"].Value, avgViews)</small>
                                }
                            </div>
                        </div>
                    </div>

                    @* Duration Analysis *@
                    @{
                        var daysSinceFirst = (Model.Hashtag.LastSeen - Model.Hashtag.FirstSeen).Days;
                        var isStillHot = (DateTime.UtcNow - Model.Hashtag.LastSeen).TotalDays <= 7;
                        var daysSinceLastSeen = (int)(DateTime.UtcNow - Model.Hashtag.LastSeen).TotalDays;
                    }
                    <div class="alert @(isStillHot ? "alert-success" : "alert-warning") mt-4 mb-0 border-start border-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <i class="bi bi-@(isStillHot ? "check-circle-fill" : "clock-history") me-2"></i>
                                <strong>@Localizer["Details_Status"]</strong>
                                @if (isStillHot)
                                {
                                    <span><strong class="text-success">@Localizer["Details_StillHot"]</strong> (@(daysSinceLastSeen < 1 ? Localizer["Details_LastSeenToday"].Value : string.Format(Localizer["Details_LastSeenDaysAgo"].Value, daysSinceLastSeen)))</span>
                                }
                                else
                                {
                                    <span><strong>@Localizer["Details_CooledDown"]</strong> (@string.Format(Localizer["Details_NotInTrendingDays"].Value, daysSinceLastSeen))</span>
                                }
                            </div>
                            <div class="col-md-4 text-md-end mt-2 mt-md-0">
                                <small class="text-muted">@string.Format(Localizer["Details_HotDuration"].Value, daysSinceFirst)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* FAQ Section *@
    <div class="row mb-4">
        <div class="col-12">
            <div class="card metric-card">
                <div class="card-header card-header-gradient-warning">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-question-circle-fill"></i> @Localizer["Details_FAQTitle"]</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item border-0 mb-2">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                    <i class="bi bi-1-circle-fill text-primary me-2"></i> @string.Format(Localizer["Details_FAQ1_Question"].Value, Model.Hashtag.TagDisplay)
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    @string.Format(Localizer["Details_FAQ1_Answer"].Value, Model.Hashtag.TagDisplay)
                                    @if (Model.Metrics != null && Model.Metrics.PredictedViewMin.HasValue)
                                    {
                                        var minViews = Model.Metrics.PredictedViewMin.Value >= 1_000_000
                                            ? $"{Model.Metrics.PredictedViewMin.Value / 1_000_000.0:F1}M"
                                            : Model.Metrics.PredictedViewMin.Value >= 1000
                                                ? $"{Model.Metrics.PredictedViewMin.Value / 1000.0:F1}K"
                                                : Model.Metrics.PredictedViewMin.Value.ToString("N0");
                                        var maxViews = Model.Metrics.PredictedViewMax.HasValue
                                            ? (Model.Metrics.PredictedViewMax.Value >= 1_000_000
                                                ? $"{Model.Metrics.PredictedViewMax.Value / 1_000_000.0:F1}M"
                                                : Model.Metrics.PredictedViewMax.Value >= 1000
                                                    ? $"{Model.Metrics.PredictedViewMax.Value / 1000.0:F1}K"
                                                    : Model.Metrics.PredictedViewMax.Value.ToString("N0"))
                                            : minViews;
                                        @Html.Raw(string.Format(Localizer["Details_FAQ1_ViewPrediction"].Value, $"<strong>{minViews}</strong>", $"<strong>{maxViews}</strong>"))
                                    }
                                    @Localizer["Details_FAQ1_Conclusion"]
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item border-0 mb-2">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                    <i class="bi bi-2-circle-fill text-primary me-2"></i> @string.Format(Localizer["Details_FAQ2_Question"].Value, Model.Hashtag.TagDisplay)
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    @if (Model.RelatedHashtags.Any())
                                    {
                                        var relatedTags = string.Join(", ", Model.RelatedHashtags.Take(5).Select(h => h.Tag.Trim()));
                                        @string.Format(Localizer["Details_FAQ2_Answer_WithRelated"].Value, relatedTags)
                                    }
                                    else
                                    {
                                        @Localizer["Details_FAQ2_Answer_NoRelated"]
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item border-0 mb-2">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                    <i class="bi bi-3-circle-fill text-primary me-2"></i> @Localizer["Details_FAQ3_Question"]
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    @Html.Raw(Localizer["Details_FAQ3_Answer"].Value)
                                    @{
                                        var isWeekendTrend = Model.Hashtag.Tag.ToLower().Contains("weekend") ||
                                                           Model.Hashtag.Tag.ToLower().Contains("cuoituan") ||
                                                           Model.Hashtag.Tag.ToLower().Contains("thứbảy") ||
                                                           Model.Hashtag.Tag.ToLower().Contains("chủnhật");
                                    }
                                    @if (isWeekendTrend)
                                    {
                                        @Localizer["Details_FAQ3_WeekendTip"]
                                    }
                                    else if (Model.Hashtag.Category != null && (Model.Hashtag.Category.Name.Contains("Music") || Model.Hashtag.Category.Name.Contains("Entertainment")))
                                    {
                                        @Localizer["Details_FAQ3_EntertainmentTip"]
                                    }
                                    @Localizer["Details_FAQ3_Conclusion"]
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item border-0">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                                    <i class="bi bi-4-circle-fill text-primary me-2"></i> @string.Format(Localizer["Details_FAQ4_Question"].Value, Model.Hashtag.TagDisplay)
                                </button>
                            </h2>
                            <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    @{
                                        var isGoodForBeginners = Model.Hashtag.DifficultyLevel == "Easy" || Model.Hashtag.DifficultyLevel == "Medium";
                                        var difficultyTextFaq = Model.Hashtag.DifficultyLevel == "Easy" ? Localizer["Difficulty_Low"].Value : Localizer["Difficulty_Medium"].Value;
                                    }
                                    @if (isGoodForBeginners)
                                    {
                                        @Html.Raw(string.Format(Localizer["Details_FAQ4_Answer_Yes"].Value, difficultyTextFaq))
                                    }
                                    else if (Model.Hashtag.DifficultyLevel == "Hard" || Model.Hashtag.DifficultyLevel == "Very Hard")
                                    {
                                        @Localizer["Details_FAQ4_Answer_Caution"]
                                    }
                                    else
                                    {
                                        @Localizer["Details_FAQ4_Answer_General"]
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* History Timeline *@
    <div class="row mb-4">
        <div class="col-12">
            <div class="card metric-card">
                <div class="card-header card-header-gradient-secondary">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-clock-history"></i> @Localizer["Details_HistoryTitle"]</h5>
                </div>
                <div class="card-body">
                    @if (Model.History.Any())
                    {
                        <div class="table-responsive">
                            <table class="table history-table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th><i class="bi bi-calendar"></i> @Localizer["Details_HistoryDate"]</th>
                                        <th><i class="bi bi-database"></i> @Localizer["Details_HistorySource"]</th>
                                        <th><i class="bi bi-trophy"></i> @Localizer["Details_HistoryRank"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var history in Model.History.OrderByDescending(h => h.CollectedDate).Take(50))
                                    {
                                        <tr>
                                            <td>@history.CollectedDate.ToVietnameseString()</td>
                                            <td><span class="badge bg-secondary">@history.Source.Name</span></td>
                                            <td><span class="badge badge-gradient-primary">#@history.Rank</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0 text-center py-4">
                            <i class="bi bi-info-circle"></i> @Localizer["Details_NoHistory"]
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>

    @* Keywords *@
    @if (Model.Hashtag.Keywords.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card metric-card">
                    <div class="card-header card-header-gradient-warning">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-key"></i> @Localizer["Details_RelatedKeywords"]</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var keyword in Model.Hashtag.Keywords.Where(k => k.IsActive))
                            {
                                <span class="badge bg-light text-dark border px-3 py-2 fs-6">
                                    <i class="bi bi-tag"></i> @keyword.Keyword
                                </span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Back Button - Smart navigation based on referrer *@
    <div class="row mb-4">
        <div class="col-12 text-center">
            <a href="#" id="backButton" class="btn btn-gradient-primary btn-lg px-5">
                <i class="bi bi-arrow-left"></i> <span id="backButtonText">@Localizer["Details_BackToHome"]</span>
            </a>
        </div>
    </div>

    <script>
        // Smart back button logic
        (function() {
            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const referrer = document.referrer;

            // Check if user came from within the site
            if (referrer && referrer.includes(window.location.hostname)) {
                // Check if came from search page
                if (referrer.includes('/Home/Search') || referrer.includes('/search')) {
                    backButton.href = '@Url.Action("Search", "Home")' + window.location.search;
                    backButtonText.textContent = '@Localizer["Details_BackToSearch"].Value';
                }
                // Check if came from home page
                else if (referrer.includes('/Home/Index') || referrer === window.location.origin + '/' || referrer.endsWith(window.location.hostname + '/')) {
                    backButton.href = '@Url.Action("Index", "Home")';
                    backButtonText.textContent = '@Localizer["Details_BackToHome"].Value';
                }
                // Came from somewhere else on site - use browser back
                else {
                    backButton.href = 'javascript:history.back()';
                    backButtonText.textContent = '@Localizer["Details_Back"].Value';
                }
            } else {
                // Came from external site or direct URL - go to home
                backButton.href = '@Url.Action("Index", "Home")';
                backButtonText.textContent = '@Localizer["Details_BackToHome"].Value';
            }
        })();
    </script>
</div>

@section Scripts {
    <script>
        const creatorsContainer = document.getElementById('creatorsContainer');
        if (creatorsContainer) {
            const creatorsJson = creatorsContainer.dataset.creators;
            if (creatorsJson) {
                try {
                    const creators = JSON.parse(creatorsJson);
                    if (creators && creators.length > 0) {
                        const html = creators.slice(0, 3).map((creator, index) => `
                            <div class="creator-card creator-card-border d-flex align-items-center mb-3 p-3 border-start border-4 rounded bg-light">
                                <div class="creator-avatar me-3">
                                    <img src="${escapeHtml(creator.avatar_url)}"
                                         alt="${escapeHtml(creator.nick_name)}"
                                         class="rounded-circle avatar-sm"
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2755%27 height=%2755%27%3E%3Crect fill=%27%23ddd%27 width=%2755%27 height=%2755%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%23999%27 font-size=%2724%27%3E${(index + 1)}%3C/text%3E%3C/svg%3E'">
                                </div>
                                <div class="creator-info flex-grow-1">
                                    <div class="fw-bold fs-6">${escapeHtml(creator.nick_name)}</div>
                                    <small class="text-muted">
                                        <i class="bi bi-trophy-fill text-warning"></i> Top ${index + 1} Creator
                                    </small>
                                </div>
                            </div>
                        `).join('');
                        creatorsContainer.innerHTML = html;
                    } else {
                        creatorsContainer.innerHTML = '<p class="text-muted mb-0 text-center py-3"><i class="bi bi-info-circle"></i> @Localizer["Details_NoCreatorsInfo"].Value</p>';
                    }
                } catch (e) {
                    console.error('Error parsing creators JSON:', e);
                    creatorsContainer.innerHTML = '<p class="text-muted mb-0 text-center py-3"><i class="bi bi-exclamation-triangle"></i> @Localizer["Details_CreatorsLoadError"].Value</p>';
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
}
